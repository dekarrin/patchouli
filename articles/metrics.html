<!DOCTYPE html>
<html>
<head>
	<title>Metrics for H@H Client :: Patchouli Documentation</title>
	<link rel="stylesheet" type="text/css" href="../styles.css" />
	<meta charset="UTF-8" />
	<meta name="description" content="Setting up a metrics stack for H@H." />
	<meta name="author" content="Rebecca C. Nelson" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!--[if lt IE 9]>
  <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
  <![endif]-->
</head>
<body>
	<p class="backlink">
		<a href="../"><img src="../patchoulismall.png" width="20px">Back to Archive</a>
	</p>
	<main class="article">
		<h1>Metrics for H@H Client</h1>
		<p class="subtitle">A tutorial for monitoring your client using Telegraf and Grafana</p>
		<p class="subtitle">By dekarrin</p>
		<p>
			This tutorial is a step-by-step process for the setup of a system for monitoring the
			Hentai@Home client using graphs and automated alerts. It uses the Grafana web
			application to show charts of the client’s performance and hath generation, Telegraf to
			both collect information from the host machines of the H@H clients as well as to collect
			information on the Hath network performance from the main Hentai@Home website, and
			InfluxDB as the metric storage backend. DigitalOcean is used to host these services on a
			server separate from the H@H clients in order to provide constant monitoring even during
			client downtime.
		</p>
		<div class="captioned-image">
			<img src="../images/metrics/example-chart.png" width="700px" alt="Example Chart">
			<p>An example of one of the charts that this tutorial will help to set up.<p>
		</div>
		<p>
			This tutorial is split into several sections. I recommend going through each section in
			order; it might be possible to do the sections out of order, but it could result in
			parts of the metrics pipeline being unstable until the rest of the sections are
			completed.
		</p>
		<h2>Table of Contents</h2>
		<ul>
			<li><a href="#requirements">Requirements</a></li>
			<li><a href="#creating-the-server">Creating the Metrics Server</a>
				<ul>
					<li><a href="#create-instance">Create an Instance on Digital Ocean</a></li>
					<li><a href="#lock-down">Lock Down Instance with Firewall/Security Group</a></li>
					<li><a href="#dns">Create Domain Name Records</a></li>
				</ul>
			</li>
			<li><a href="#basic-setup">Basic Server Setup</a>
				<ul>
					<li><a href="#basic-utils">Install Basic Utilities</a></li>
					<li><a href="#users-and-groups">Create Users and Groups</a></li>
					<li><a href="#lets-encrypt">Obtain a TLS Certificate with Let's Encrypt</a></li>
				</ul>
			</li>
			<li><a href="#influxdb">Setting up InfluxDB</a>
				<ul>
					<li><a href="#influxdb-install">Install InfluxDB</a></li>
					<li><a href="#influxdb-setup">Set Up Database and InfluxDB Users</a></li>
				</ul>
			</li>
			<li><a href="#telegraf-client">Setting up Telegraf on the Clients</a></li>
			<li><a href="#telegraf-server">Setting up Telegraf on the Metrics Server</a>
				<ul>
					<li><a href="#install-telegraf">Install Telegraf</a></li>
					<li><a href="#install-pytelegrafhttp">Install PyTelegrafHTTP</a></li>
				</ul>
			</li>
			<li><a href="#grafana">Setting up Grafana</a>
				<ul>
					<li><a href="#grafana-install">Install Grafana</a></li>
					<li><a href="#grafana-charts">Create Charts</a></li>
				</ul>
			</li>
			<li><a href="#whats-next">Where to go from Here</a>
				<ul>
					<li><a href="#alerting">Alerting</a></li>
					<li><a href="#ifttt">Using IFTTT for Phone Notifications</a></li>
					<li><a href="#backup">Backups</a></li>
				</ul>
			</li>
		</ul>
		<h2 id="requirements">Requirements</h2>
		<p>
			There are a few things that you will need in order to set up the metrics stack. You are
			of course free to substitute the requirements as you see fit, but this is the system
			that works for me. If you do end up finding different ways to do things, please let me
			know and I would be happy to include it in this document.
		</p>
		<p>Here is what you will need (all prices given are in United States Dollar):
		<ul>
			<li><b>At least one Hentai@Home client that is already running and is actively
				contributing to the hath network.</b> This guide will not be very helpful if you
				don’t already have a running client; go to
				<a href="https://e-hentai.org/hentaiathome.php">the H@H info page</a> for info on
				running a client. Actually setting up the client is beyond the scope of this guide;
				please refer to the link and/or contact Tenboro on the forums for help with the
				actual set up and administration of the client.
			</li>
			<li><b>At least one web-accessible server that you have full root access on, or about
				$5/month to buy one from DigitalOcean, preferably completely separate from the
				Hentai@Home host machine.</b> This box will be used to host the data storage backend
				InfluxDB as well as the chart and graph front-end, Grafana. It will also be used to
				collect metrics on your client from the Hentai@Home client info page using Telegraf.
				If you wish to separate these functionalities into separate servers, by all means
				please do. I recommend against putting these services on any boxes that are also
				hosting the H@H client; again <span class="warning">this must be separate from the
				H@H client machine, or you will not be able to see metrics or get alerts when that
				client goes down.</span> I also do not recommend self-hosting this box at home; it’s
				only $5/month for a micro instance from DigitalOcean and only a little bit more for
				instances on other IaaS, and that gets you the assurance that your monitoring is
				always up without you having to deal with the headache of infrastructure management
				and maintenance.
			</li>
			<li><b>A domain name, or about $10 to $30 per year to buy one (price depends on the
				TLD/ending).</b> It will make your life far easier, especially when setting up
				proper HTTPS certificates for your Grafana application. My typical strategy is to
				buy a single domain name and use subdomains to point to different services on
				different servers. If you don’t yet have a domain name, you can buy one from
				<a href="https://www.namecheap.com/">Namecheap</a>, and usually the first year is
				available at a much-reduced rate.
			</li>
		</ul>
		<h2 id="creating-the-server">Creating the Metrics Server</h2>
		<p>
			You will need a place for Grafana, InfluxDB, and the hath network metrics collection
			daemon to live. I recommend that this be separate from any box that is hosting a H@H
			client, because if it isn’t and that box goes down, you will get zero notifications that
			your client went down. For the same reason, it’s a good idea to have it hosted on a
			different network than the one that your H@H clients are on.
		</p>
		<p>
			You will need a server that is connected to the internet and that you have full root
			access on. Additionally, you will probably want a server with reliable uptime. You do
			not need a very beefy machine; I’ve found that a box with 512MB of RAM and 20GB of disk
			space is perfectly sufficient for my current needs.
		</p>
		<p>
			The quick and easy ways to get a server with good uptime that you don’t have to worry
			about maintaining yourself are to get an instance on an Infrastructure-as-a-Service
			system or to get a VPS. VPSs tend to be a little on the slower side at smaller scale,
			do not often offer easy scaling options (not that this is a concern here), but most
			importantly do not usually give you full root access to the machine; for those reasons,
			I recommend getting a VM instance.
		</p>
		<h3 id="create-instance">Create an Instance on Digital Ocean</h3>
		<p>
			This section of the guide walks through the steps required to set up an instance on
			DigitalOcean to use as the metrics server. If you already have a machine that meets the
			requirements for a metrics server, feel free to skip this step and continue with
			<a href="#dns">Create Domain Name Records</a>.
		</p>
		<p>
			DigitalOcean is an IaaS platform that offers excellent prices for small-scale VMs. They
			call their instances “droplets”, and they offer a variety of different types depending
			on what your needs are. For our purposes, the smallest standard droplet they offer is
			perfectly sufficient, and costs only $5 per month at the time of this writing.
		</p>
		<p>
			First, head over to <a href="https://www.digitalocean.com/">DigitalOcean</a> and create an account. You will need to enter credit
			card information so that you can be billed for you instance, but generally with IaaS
			platforms, you will not be charged until the billing period has ended.
		</p>
		<p>
			The way we will be setting up the server infrastructure, it is extremely unlikely that
			you will be charged anything above $5 per month, but as with other IaaS platforms, you
			are billed based on usage, so it might be a good to set up a “Billing Alert” on the
			off-chance that something is inadvertently changed which causes you to be billed more
			than you would like. I set my alert to ping me if my bill ever exceeds $10 to be on the
			safe side. To configure this, head over to your account settings, go under “Billing”,
			and scroll down to “Billing Alerts” to set a threshold for you to be warned at. Don’t
			forget to save!
		</p>
		<p>
			Okay cool, now let’s actually create an instance. Hit the green Create button at the top
			right corner of the page and select “Droplets” (or just go to
			<a href="https://cloud.digitalocean.com/droplets/new">https://cloud.digitalocean.com/droplets/new</a>).
		</p>
		<p>
			You will need to select an operating system. The rest of this guide assumes that you are
			using Ubuntu, but you can select a different distro if you are more familiar with it and
			prefer it (though you will need to know how to translate the rest of this guide into the
			dialect of that distro). Just make sure to select a Linux distribution (note that BSD is
			not the same as Linux!), or you are on your own for the rest of the guide.
		</p>
		<p>
			Next, choose a droplet size. The smallest profile under “Standard Droplets” will work
			just fine; at the time of this writing that is a 1GB RAM/1 CPU/25GB Disk Space/1 TB
			Transfer image that costs $5 per month. If you really would prefer to have a beefier
			box, go for it, but it will cost you more.
		</p>
		<p>
			Block Storage / Volumes are only necessary if you find you need more space on your
			droplet, but will cost you more. You really don’t need it; 25 GB is fine to start with
			and you can always add volumes to your instance later.
		</p>
		<p>
			For the data center, pick whatever you want. At the the scale that we are dealing with
			here it really doesn’t matter. If I had to make a recommendation, I’d say pick a
			location that is generally closest to you for general use, as it might be miniscule
			fractions of a second faster. All of the data centers are just fine, though note that
			some features (such as block storage) are limited to particular data centers.
		</p>
		<p>
			For additional options, check whatever makes sense to you. I have my box set up with
			IPv6 and Monitoring. It’s also be a good idea to add weekly Backups. This will cause
			your bill to be a little higher (20% higher as of the time of this writing), but it is
			well worth it to ensure your data is not lost in the event of catastrophic system
			failure.
		</p>
		<p>
			Setting up an SSH key during droplet set up is not a requirement, but it will make it so
			that the initial root password does not have to be sent to you over email. If you aren’t
			already familiar with using SSH keys to authenticate to remote servers, don’t worry
			about it, though I recommend you get familiar with them at some point as they will make
			your dev-ops life easier.
		</p>
		<p>
			Finally, choose a hostname for your droplet. This is a name for your droplet, and if you
			want, you can stay with the default name which is based on the droplet profile, but I
			find it makes it much easier to give it a more meaningful name. Many admins give the
			hosts names based on the application running on the server; I give my hosts names based
			on waifus. For my server infrastructure, I use Touhou characters such as “sakuya”,
			“flandre”, “patchouli”, etc. No matter what, in order to make your life easier, make
			sure to use only lower-case characters and dashes; this will also make it so your domain
			names can be the same as your host names. For the purposes of this guide, I’m going to
			call mine “meiling”.
		</p>
		<p>
			Finally, hit “Create”, give the box a few moments to spin up, and you are done! You
			should now have an internet-accessible droplet with a static IPv4 address (and a static
			IPv6 address if you had selected it).
		</p>
		<p>
			Before we log in for the first time, we’ll secure the droplet by setting up a cloud
			firewall, and we will set up a domain name for the host and put it on a subdomain so we
			can access it via name instead of via IP address.
		</p>
		<h3 id="lock-down">Lock Down Instance with Firewall/Security Group</h3>
		<p>
			On DigitalOcean, new droplets are open to the internet on all ports. This is not the
			greatest idea; we will want to close all ports that are not necessary for operation. To
			do this, we will create a “Cloud Firewall” (also known as a “Security Group” on some
			IaaS platforms).
		</p>
		<p>
			Go to the “Networking” tab on DigitalOcean, and select the “Firewalls” sub-tab. Hit the
			“Create Firewall” button and call it something meaningful; something like
			“Influx-Grafana-HathTele” will work just fine.
		</p>
		<p>
			For Inbound Rules, first make sure that there is a rule for SSH over TCP for All IPv4
			and All IPv6. If you do not, you will not be able to log in to your instance over SSH.
		</p>
		<p>
			Add an inbound rule for HTTP and a rule for HTTPS; the fields should auto-populate, but
			make sure both rules contain the sources “All IPv4” and “All IPv6”. This will allow
			Grafana to be accessed over the web, as well as enable Certbot for automatic TLS
			certificate renewal.
		</p>
		<p>
			Also add a “Custom”-type inbound rule for TCP traffic under port 8086, again making sure
			it contains the sources “All IPv4” and “All IPv6”. This will make InfluxDB accessible
			over the web.
		</p>
		<p>
			The default outbound rules should be fine. Make sure that ICMP, All TCP, and All UDP
			exist as rules, and make sure they each have “All IPv4” and “All IPv6” in their
			“Destinations” fields.
		</p>
		<p>
			Under “Apply to Droplets”, start typing the hostname of your droplet and select it from
			the list when it pops up.
		</p>
		<p>
			Finally, hit the “Create Firewall” button to save the firewall and apply it to your
			instance. Now, traffic on other ports will not be allowed through, and your box is
			slightly more secure. I mean don’t go around bragging about it, this is super basic
			security. But at least it won’t ever listen to traffic on other ports if someone happens
			to install malicious server software on the box.
		</p>
		<p>
			Next, we’ll configure domain name records so you can access your box with a nice
			internet address instead of a bunch of mean-looking numbers.
		</p>
		<h3 id="#dns">Create Domain Name Records</h3>
		<p>
			This section has information on moving a domain name over to DigitalOcean for use with
			your droplets and then using DigitalOcean to assign a subdomain to your droplet. If you
			don’t yet own a domain name, head over to Namecheap or wherever you want to pick one up.
			They run from about $10 to $30 per year depending on the ending; .com’s are about $11
			per year. If you will not be setting up a domain name or you already have one set up,
			feel free to skip down to <a href="#basic-setup">Basic Server Setup</a> to start
			administrating your server immediately.
		</p>
		<p>
			Once you have a domain name purchased, you will need to transfer it to DigitalOcean.
			They already have a <a href="https://www.digitalocean.com/community/tutorials/how-to-point-to-digitalocean-nameservers-from-common-domain-registrars">great guide</a>
			written up for how to do this, so head over there and complete the steps there.
		</p>
		<p>
			Once the nameservers have been properly updated, head over to the Networking tab of the
			DigitalOcean control panel. You should see your domain name in the list there; if you
			don’t, go ahead and add the raw (without anything before it, including www) domain name.
			For example, if I were to own the domain “example.com”. I would enter that exactly
			(without the quotes). Don’t actually use example.com, use whatever domain name you own.
		</p>
		<p>
			Next, we will add some DNS records to point at your server. Click on your domain in the
			list and you should see the “Create New Record” interface. Go to the “A” tab to create a
			new A-record; this will point the domain name to your droplet’s IPv4 address.
		</p>
		<p>
			We’ll be using a subdomain, which is the part in the address that comes before the
			domain we purchased. For example, in “www.example.com”, “example.com” would be the
			domain name and “www” would be the subdomain. Enter something memorable; it usually
			makes sense to just call it the same as whatever hostname you assigned to the droplet
			during creation. Enter the subdomain in the “Hostname” field (for the instance I created
			during this guide, I would use “meiling” as the subdomain).
		</p>
		<p>
			In the “Will Direct To” box, select the droplet that you created. In the “TTL” field,
			put down a number that makes sense. This number is how often the DNS network will check
			for changes in the record, and will affect how long it takes to update should you ever
			change what the record points to. 3600 seconds is one hour and is just fine.
		</p>
		<p>
			Finally, hit the “Create Record” button and you are done! If you enabled IPv6 for your
			droplet, you should also create an AAAA-record going to the “AAAA” tab and repeating the
			process with the same information.
		</p>
		<p>
			That’s it! Your instance is now accessible by a human-readable internet address rather
			than a spoopy scary-skeletons set of numbers. But, note that you won’t get anything yet
			if you try to go there in a web browser; we still need to set up the server.
		</p>
		<p>
			Grab your root password from your email, pull up a terminal (or PuTTY if you are on
			Windows), and SSH to root@your-internet-address-that-you-just-set-up, and you’ll be in
			business! If all has gone well, you’ll be presented with a terminal prompt on your new
			box, and will be required to immediately change the root password. Please do so, but
			note that this will not be your main user if you follow the rest of the guide.
		</p>
		<p>
			Now it’s time to move on to setting up the server.
		</p>
		<h2 id="basic-setup">Basic Server Setup</h2>
		<p>
			So, now we’ve got a box somewhere on the internet. Awesome! The next step is to log in
			to it and start configuring everything. Before we jump to the metrics stack, we’ll need
			to do some basic server setup first.
		</p>
		<p>
			If you’ve been following the guide so far, you won’t yet have any users set up, so log
			into your instance as the user ‘root’ (root@your-box-address).
		</p>
		<h3 id="basic-utils">Install Basic Utilities</h3>
		<p>
			First, as soon as you’re logged in, make sure all of the existing software is up to
			date. If your instance’s distro is Ubuntu or another Debian-like, follow the
			instructions in this guide; otherwise, do whatever the equivalent for your distro is. If
			your instance is running on a non-Linux OS, god help you.
		</p>
		<p>
			Install updates to the package lists:
		</p>
		<p class="code">root@meiling:~# apt-get update</p>
		<p>
			Now install any available updates:
		</p>
		<p class="code">root@meiling:~# apt-get upgrade</p>
		<p>
			Type Y if required to continue with the install.
		</p>
		<p>
			If there were messages during the update about packages that are no longer required, you
			can remove them after the update completes:
		</p>
		<p class="code">root@meiling:~# apt-get autoremove</p>
		<p>
			Next, we’ll install some programs that will make life easier on this system.
		</p>
		<p>
			If you do not have 'sudo' on your system, install it now. You can test whether you have
			sudo by trying to use it. If you don’t have it, you will see the following:
		</p>
		<p class="code">sudo: command not found</p>
		<p>
			If you don't have it, go ahead and install it now.
		</p>
		<p class="code">root@meiling:~# apt-get install sudo</p>
		<p>
			Next, you’ll want a text editor. For simplicity’s sake, this guide will use the ‘nano'
			editor, but if you prefer, you can install vim, emacs, or whatever you want.
		</p>
		<p class="code">root@meiling:~# apt-get install nano</p>
		<p>
			In all likelihood, it will already be installed.
		</p>
		<p>
			That’s it for initial software and set up! If you would like, I’d also recommend
			installing `screen` or `tmux` so you can keep your session open even if you lose your
			connection while you are SSH’d into your box, but it is by no means necessary. Next,
			we’ll move on to creating a user for yourself.
		</p>
		<h3 id="#users-and-groups">Create Users and Groups</h3>
		<p>
			Right now, you are logged into your system as the root user. This is generally not a
			good idea, because the root user is unrestricted and if it were compromised, the
			attacker would have full system access. You really only need to be logged in as root in
			special circumstances; for general use, you’ll want to create a new user for yourself on
			your box that can only perform restricted, ‘regular’ actions. We’ll also set it up so
			the user can elevate its permissions temporarily as needed with the ‘sudo’ command.
		</p>
		<p>
			First, create the new user for yourself. For the username, pick something that is easy
			to remember. It doesn’t have to be secret; for me personally, I just use ‘dekarrin’.
			Another common method of creating usernames is just your initials; for me, this would be
			‘rcn’, for Richard Stallman, it would be ‘rms’. No matter what, unless you want your
			life to be difficult, make sure it’s all lowercase and has no punctuation, and create
			the user.
		</p>
		<p class="code">root@meiling:~# adduser dekarrin</p>
		<p>
			You will prompted to set a password for the new user. <span class="warning">SET IT TO
			SOMETHING OTHER THAN THE ROOT PASSWORD.</span> If you don’t, setting up the additional
			user is completely pointless.
		</p>
		<p>
			You may be prompted for additional information on the new user; feel free to fill it in
			as you wish or just leave fields blank and hit enter.
		</p>
		<p>
			Once you are done, confirm that the new user exists by running the `id` command. You
			should see something along the lines of the following:
		</p>
		<p class="code">root@meiling:~# id dekarrin
uid=1000(dekarrin) gid=1000(dekarrin) groups=1000(dekarrin)</p>
		<p>
			If you see <span class="code">id: ‘dekarrin’: no such user</span>, then the user has not
			been set up properly, and you’ll need to try again.
		</p>
		<p>
			Next, add your user to the supplementary group ‘sudo’ to allow it to run the sudo
			command. The sudo command is used for performing privileged action as an unprivileged
			user; it is very necessary unless you want to be switching to the root user every time
			you need to do system config.
		</p>
		<p class="code">root@meiling:~# usermod -a -G sudo dekarrin</p>
		<p>
			Confirm that the change worked by running `id` and making sure that sudo appears in the
			groups that the user is a member of.
		</p>
		<p class="code">root@meiling:~# id dekarrin
uid=1000(dekarrin) gid=1000(dekarrin) groups=1000(dekarrin),27(sudo)</p>
		<p>
			Now, you need to make sure that the ‘sudo’ group is authorized to execute sudo. This
			will be in the ‘sudoers’ configuration file. The exact location may vary by distro, but
			that file should not be modified directly anyways. Instead, we will use the ‘visudo’
			command, which will allow us to edit the config with nano, and once we are done, it will
			make sure that the edited contents are valid before using it.
		</p>
		<p class="code">root@meiling:~# visudo</p>
		<p>
			Scroll through the file using the arrow keys, and make sure that the line
			<span class="code">%sudo   ALL=(ALL:ALL) ALL</span> exists somewhere in the file.
		</p>
		<p>
			If it exists, but has a hash character in front of it (‘#’), remove the hash character.
			If the line does not exist, scroll to the bottom of the file and add it.
		</p>
		<p>
			When done, use the keyboard command given on the bottom of the screen to ‘Write-out’
			(save) the file. The ‘^’ character in the shortcuts refers to the ‘Control’ key. The
			command for writing out in nano is ^O (Control-O). Hit it and you will then be prompted
			to give a name for the file. Leave it as the default and hit enter, then do ^X to exit
			from nano.
		</p>
		<p>
			Now, your new user is set up and can use sudo. Log out of the instance with ‘exit’, and
			log back in as your new user (“yournewuser@yourserver”).
		</p>
		<p class="code">root@meiling:~# exit
logout
Connection to meiling.example.com closed.
[z002v4m@dca9047d6bab 09:27:43 ~]$ ssh dekarrin@meiling.example.com
dekarrin@meiling.example.com's password:
…
dekarrin@meiling:~$</p>
		<p>
			Double-check that sudo is working properly with a test command:
		</p>
		<p class="code">dekarrin@meiling:~$ sudo echo test
[sudo] password for dekarrin:
test
dekarrin@meiling:~$</p
		<p>
			Depending on the distro, it’s possible that the first time you use sudo, you will be
			presented with a prompt that asks you to accept the responsibility of being able to use
			the sudo command. That’s fine, accept the prompt.
		</p>
		<p>
			From now on, it is a good idea to never log in as the root user except in emergencies.
			For any further steps for the rest of this guide, make sure to be logged in as your new
			user, not as the root user.
		</p>
		<p>
			One last thing is required before all the users and groups are set up. For the SSL/TLS
			certificates on your server, you will want to create a group that will own them so that
			root is not the only one able to access/use them.
		</p>
		<p class="code">dekarrin@meiling:~$ sudo groupadd ssl-cert</p>
		<p>
			Now you are done with user/group set up and can move on to getting your SSL certificates
			set up.
		</p>
		<h3 id="lets-encrypt">Obtain a TLS Certificate with Let's Encrypt</h3>
		<p>
			In order to authenticate your server to the internet, as well as encrypt your metrics
			traffic and dashboard traffic, you will want to use TLS certificate encryption. TLS/SSL
			certificates are most commonly known for being the method by which HTTPS operates, but
			they are used in a variety of other environments as well.
		</p>
		<p>
			<a href="https://letsencrypt.org/">Let's Encrypt</a> is a Certificate Authority that can
			be used to obtain a TLS certificate ree-of-charge. This is an exciting development in
			making the internet a more secure place; in the past, public Certificate Authorities
			were mainly government and regulatory bodies, and all of them charged a fee for
			processing certificate applications and renewals.
		</p>
		<p>
			First, you need to install Certbot, which will automate the renewal and request process
			for certificates. Add the Ubuntu PPA for Certbot to APT's packages:
		</p>
		<p class="code">dekarrin@meiling:~$ sudo apt-add-repository ppa:certbot/certbot
[sudo] password for dekarrin:
 This is the PPA for packages prepared by Debian Let's Encrypt Team and backported for Ubuntu(s).
 More info: https://launchpad.net/~certbot/+archive/ubuntu/certbot
Press [ENTER] to continue or ctrl-c to cancel adding it

gpg: keyring `/tmp/tmpy6_m4x5_/secring.gpg' created
gpg: keyring `/tmp/tmpy6_m4x5_/pubring.gpg' created
gpg: requesting key 75BCA694 from hkp server keyserver.ubuntu.com
gpg: /tmp/tmpy6_m4x5_/trustdb.gpg: trustdb created
gpg: key 75BCA694: public key "Launchpad PPA for certbot" imported
gpg: Total number processed: 1
gpg:               imported: 1  (RSA: 1)
OK</p>
		<p>
			Then, update the package list.
		</p>
		<p class="code">dekarrin@meiling:~$ sudo apt-get update
Hit:1 https://repos.sonar.digitalocean.com/apt main InRelease
Get:2 http://security.ubuntu.com/ubuntu xenial-security InRelease [102 kB]
Hit:3 http://nyc2.mirrors.digitalocean.com/ubuntu xenial InRelease
Get:4 http://ppa.launchpad.net/certbot/certbot/ubuntu xenial InRelease [24.3 kB]
Get:5 http://nyc2.mirrors.digitalocean.com/ubuntu xenial-updates InRelease [102 kB]
Get:6 http://nyc2.mirrors.digitalocean.com/ubuntu xenial-backports InRelease [102 kB]
Get:7 http://nyc2.mirrors.digitalocean.com/ubuntu xenial-updates/main amd64 Packages [724 kB]
Get:8 http://nyc2.mirrors.digitalocean.com/ubuntu xenial-updates/universe amd64 Packages [588 kB]
Get:9 http://ppa.launchpad.net/certbot/certbot/ubuntu xenial/main amd64 Packages [14.9 kB]
Get:10 http://ppa.launchpad.net/certbot/certbot/ubuntu xenial/main Translation-en [9,252 B]
Fetched 1,667 kB in 0s (1,844 kB/s)
Reading package lists... Done</p>
		<p>And then install Certbot.</p>
		<p class="code">dekarrin@meiling:~$ sudo apt-get install certbot</p>
		<p>
			Now execute Certbot, and use it to request a certificate from Let's Encrypt. Replace the
			domain at the end of the following command with the full domain that you have set up for
			your instance:
		</p>
		<p class="code">dekarrin@meiling:~$ sudo certbot certonly --standalone --preferred-challenges http -d meiling.example.com</p>
		<p>
			Enter an email address when prompted and answer the other prompts appropriately. The
			challenge server will run, and when it is completed you will see a message indicating
			that your certificates have been set up.
		</p>
		<p>
			Next, you will need to add a script that will properly set the permissions on the
			certificates after renewal has completed. Open a new file in the renewal hooks section
			of the local Let's Encrypt config.
		</p>
		<p class="code">dekarrin@meiling:~$ sudo nano /etc/letsencrypt/renewal-hooks/deploy/set-cert-permissions.sh</p>
		<p>
			Then copy the following content into the file:
		</p>
		<p class="code">#!/bin/sh

if [ "$(id -u)" -ne 0 ]
then
  "Must be run as root" >&2
  exit 1
fi

chgrp ssl-cert /etc/letsencrypt/live
chgrp -R ssl-cert /etc/letsencrypt/archive
chmod 750 /etc/letsencrypt/live
chmod 750 /etc/letsencrypt/archive
chgrp ssl-cert "$RENEWED_LINEAGE"
chmod 750 "$RENEWED_LINEAGE"

for x in $(ls "$RENEWED_LINEAGE")
do
  chgrp ssl-cert "$RENEWED_LINEAGE/$x"
  chmod 654 "$RENEWED_LINEAGE/$x"
done
#systemctl restart influxdb
#systemctl restart grafana-server
#systemctl restart telegraf</p>
		<p>
			Once we are done setting up the components of our server, you will go back and uncomment
			them in the file, but for now, keep them commented.
		</p>
		<p>
			Give the script execution permission so that Certbot can run it.
		</p>
		<p class="code">dekarrin@meiling:~$ sudo chmod 744 /etc/letsencrypt/renewal-hooks/deploy/set-cert-permissions.sh</p>
		<p>
			Now that the script is in place, run certbot again and force renewal of your
			certificates so the deploy script has a chance to run.
		</p>
		<p class="code">dekarrin@meiling:~$ sudo certbot renew --force-renew</p>
		<p>
			And that's it! The certificates are now ready to go, and you can start setting up the
			components of the metrics server.
		</p>
		<h2 id="influxdb">Setting Up InfluxDB</h2>
		<p>
			InfluxDB is the storage backend that you will be using to store metrics on. It is a
			NoSQL database that has a time-series structure which makes it suitable for storing
			metrics very efficiently.
		</p>
		<h3 id="influxdb-install">Install InfluxDB</h3>
		<p>
			First, add the InfluxData repository to APT.
		</p>
		<p class="code">dekarrin@meiling:~$ sudo su
root@meiling:/home/dekarrin# curl -sL https://repos.influxdata.com/influxdb.key | sudo apt-key add -
root@meiling:/home/dekarrin# source /etc/lsb-release
root@meiling:/home/dekarrin# echo "deb https://repos.influxdata.com/${DISTRIB_ID,,} ${DISTRIB_CODENAME} stable" | sudo tee /etc/apt/sources.list.d/influxdb.list
root@meiling:/home/dekarrin# exit</p>
		<p>
			Next, update the package lists.
		</p>
		<p class="code">dekarrin@meiling:~$ sudo apt-get update</p>
		<p>
			And then install InfluxDB.
		</p>
		<p class="code">dekarrin@meiling:~$ sudo apt-get install influxdb</p>
		<p>
			Before starting up InfluxDB, we need to modify the configuration settings. Open the
			config file as root:
		</p>
		<p class="code">dekarrin@meiling:~$ sudo nano /etc/influxdb/influxdb.conf</p>
		<p>
			Go to the <span class="code">[retention]</span> section and set 'enabled' to 'true' and
			set 'check-interval' to "30m". This will enable rentention policies in InfluxDB, which
			allow you to set how long data persists before being deleted. This section of config
			does not actually set any retention policies; it just makes it so you can use them.
		</p>
		<p class="code">[retention]
  # Determines whether retention policy enforcement enabled.
  enabled = true

  # The interval of time when retention policy enforcement checks run.
  check-interval = "30m"</p>
  		<p>
			Under the <span class="code">[http]</span> section, uncomment and set the variables to
			the values listed. This will enable using InfluxDB over HTTP.
		</p>
		<p class="code">[http]
  # Determines whether HTTP endpoint is enabled.
  enabled = true

  # The bind address used by the HTTP service.
  bind-address = ":8086"

  # Determines whether user authentication is enabled over HTTP/HTTPS.
  auth-enabled = true

  # The default realm sent back when issuing a basic auth challenge.
  realm = "InfluxDB"</p>
  		<p>
			Also in the <span class="code">[http]</span> section, uncomment and set the variables to
			the correct values to enable HTTPS encryption/authentication. Be sure to change the
			domain name in the examples to match your instance's domain name.
		</p>
		<p class="code">  # Determines whether HTTPS is enabled.
  https-enabled = true

  # The SSL certificate to use when HTTPS is enabled.
  https-certificate = "/etc/letsencrypt/live/meiling.example.com/fullchain.pem"

  # Use a separate private key location.
  https-private-key = "/etc/letsencrypt/live/meiling.example.com/privkey.pem"</p>
		<p>
			In the <span class="code">[subscriber]</span> section, uncomment and set 'enabled' to
			false. The subscription settings are used by Kapacitor, a front-end offering by
			InfluxData. Since this guide does not use Kapacitor, it is better to disable subscribers
			entirely in order to eliminate the overhead.
		</p>
		<p class="code">[subscriber]
  # Determines whether the subscriber service is enabled.
  enabled = false</p>
		<p>
			All other values can be left to their defualts.
		</p>
		<p>
			Next, add the influxdb user to the 'ssl-cert' group in order to give it access to the
			SSL/TLS certificates.
		</p>
		<p class="code">dekarrin@meiling:~$ sudo usermod -a -G ssl-cert influxdb</p>
		<p>
			Finally, start InfluxDB.
		</p>
		<p class="code">dekarrin@meiling:~$ sudo systemctl start influxdb</p>
		<p>
			Make sure InfluxDB started successfully. You should see <span class="code">Active: active (running)</span>
			somewhere in the output:
		</p>
		<p class="code">dekarrin@meiling:~$ systemctl status influxdb
● influxdb.service - InfluxDB is an open-source, distributed, time series database
   Loaded: loaded (/lib/systemd/system/influxdb.service; enabled; vendor preset: enabled)
   Active: active (running) since Sat 2018-02-17 21:05:11 UTC; 2min 12s ago</p>
		<p>
			Now that InfluxDB is running, edit the deploy script for Let's Encrypt and uncomment
			the line that restarts InfluxDB:
		</p>
		<p class="code">dekarrin@meiling:~$ sudo nano /etc/letsencrypt/etc/letsencrypt/renewal-hooks/deploy/set-cert-permissions.sh</p>
		<p class="code">  chmod 654 "$RENEWED_LINEAGE/$x"
done
systemctl restart influxdb
#systemctl restart grafana-server
#systemctl restart telegraf</p>
		<h3 id="influxdb-setup">Set Up Database and InfluxDB Users</h3>
		<p>
			Now that InfluxDB has been installed and started, you will need to connect to the
			database and set up the databases and users.
		</p>
		
		<h2 id="telegraf-client">Setting Up Telegraf on the Clients</h2>
		<h2 id="telegraf-server">Setting Up Telegraf on the Metrics Server</h2>
		<h3 id="install-telegraf">Install Telegraf</h3>
		<h3 id="install-pytelegrafhttp">Install PyTelegrafHTTP</h3>
		<h2 id="grafana">Setting Up Grafana</h2>
		<h3 id="grafana-install">Install Grafana</h3>
		<h3 id="grafana-charts">Create Charts</h3>
		<h2 id="whats-next">Where To Go From Here</h2>
		<h3 id="alerting">Alerting</h3>
		<h3 id="ifttt">Using IFTTT for Phone Notifications</h3>
		<h3 id="backups">Backups</h3>
	</main>
	<p class="backlink">
		<a href="../"><img src="../patchoulismall.png" width="20px">Back to Archive</a>
	</p>
	<footer>
		<p><em>Last updated on
			<time datetime="2018-02-17T00:57:12Z">February 17th, 2018</time>.</em>
		</p>
		<p>
			"<a href="https://fantastiic.deviantart.com/art/Chibi-Patchouli-Knownledge-Touhou-305044472">Chibi Patchouli Knownledge (Touhou)</a>"
			by <a href="https://fantastiic.deviantart.com/">Fantastiic</a>, used under
			<a href="https://creativecommons.org/licenses/by-nc/3.0/">CC BY-NC 3.0</a> / cropped from
			original.
		</p>
		<p>
			This website's content and its code (unless otherwise specified) is copyright
			Rebecca Nelson.</p>
		<p>
			<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br />
			The content of this site is licensed under a
			<a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
		</p>
		<p>
			The code that makes up this site is licensed for use under the GPLv3; for
			the full license, click <a href="./LICENSE.txt">here</a>.
		</p>
	</footer>
</body>
</html>
